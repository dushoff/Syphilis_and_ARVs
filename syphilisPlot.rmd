---
title: "Syphils/ARV"
output: html_document
---

## Model description

### Structure

(SIT for syphilis) $\times$ (SIT for HIV) $\times$ (two risk groups) $\times$ (one gender)

### Features

* Treted people with syphilis go to class T (immune) at a rate $\gamma$ and lose immunity at a rate $\delta$ (go back to S)

* Treated people with HIV go to class T at a rate $\tau$ and have lower transmission rate as well as mortality rate. Treatment may fail or people may stop receiving treatment at a rate $\sigma$ (go back to I)

* Assortative mixing between risk groups

* Natural death and birth

* People infected with syphilis are more likely to transmit/receive HIV. This is included in the code but the ratio is set to 1 for now so it's not included in the model description below.

### Assortativity

Proportion $\rho$ of an individual's mixing is reserved for their own risk group, and the rest is used randomly in the whole population. Force of infection, $\lambda_i$, by a particular group, $Y_i$, is given by the following equation:

$$
\lambda_i = \rho \beta_i \frac{Y_i}{N_i} + (1-\rho) \beta_i \frac{\sum_i c_i Y_i}{\sum_i c_i N_i},
$$

where $i$ is the mixing group, $c_i$ is the partnership rate, $N_i$ is total number of people in the mixing group, and $\beta_i = \beta * c_i$ ($\beta$ is the transmission probability per partnership).

### Transmission

We have 9 states: $SS_i$, $IS_i$, $TS_i$, $SI_i$, $II_i$, $TI_i$, $ST_i$, $IT_i$, $TT_i$, where $i = 1, 2$. First letter represents infection status for HIV and the second letter represents infection status for syphilis. Therefore, we have $J_i^{HIV} = IS_i + II_i + IT_i + \epsilon_{\beta} (TS_i + TI_i + TT_i)$ and $J_i^{syph} = SI_i + II_i + TI_i$, which are used to calculate force of infection of two diseases ($\epsilon_{\beta}<1$ is the relative HIV transmission ratio due to ARV treatment):

$$
\begin{align}
\lambda_i^{HIV} &= \rho \beta_i^{HIV} \frac{J_i^{HIV}}{N_i} + (1-\rho) \beta_i^{HIV} \frac{\sum_i c_i J_i^{HIV} }{\sum_i c_i N_i},\\
\lambda_i^{syph} &= \rho \beta_i^{syph} \frac{J_i^{syph}}{N_i} + (1-\rho) \beta_i^{syph} \frac{\sum_i c_i J_i^{syph}}{\sum_i c_i N_i}.
\end{align}
$$

### Disease induced mortality

People infected with HIV die at a rate $\alpha$. People receiving ARV treatment have decreased death rate: $\epsilon_{\alpha} \alpha$, where $\epsilon_{\alpha} < 1$.

### Model

$$
\begin{align}
SS_i' &= \mu N(0)_i -(\lambda_i^{HIV} + \lambda_i^{syph}) SS_i + \delta ST_i - \mu SS_i \\
IS_i' &= -\lambda_i^{syph} IS_i + \lambda_i^{HIV} SS_i - \tau IS_i + \sigma TS_i + \delta IT_i - \alpha IS_i - \mu IS_i \\
TS_i' &= -\lambda_i^{syph} TS_i + \tau IS_i - \sigma TS_i + \delta TT_i - \epsilon_{\alpha} \alpha TS_i - \mu TS_i \\
SI_i' &= -\lambda_i^{HIV} SI_i + \lambda_i^{syph} SS_i - \gamma SI_i - \mu SI_i \\
II_i' &= \lambda_i^{HIV} SI_i + \lambda_i^{syph} IS_i - \tau II_i + \sigma TI_i - \gamma II_i - \alpha II_i - \mu II_i \\
TI_i' &= \lambda_i^{syph} TS_i + \tau II_i - \sigma_i TI_i - \gamma TI_i - \epsilon_{\alpha} \alpha TI_i - \mu TI_i \\
ST_i' &= -\lambda_i^{HIV} ST_i + \gamma SI_i - \delta ST_i - \mu ST_i \\
IT_i' &= \lambda_i^{HIV} ST_i - \tau IT_i + \sigma TT_i + \gamma II_i - \delta IT_i - \alpha IT_i - \mu IT_i \\
TT_i' &= \tau IT_i - \sigma TT_i + \gamma TI_i - \delta TT_i - \epsilon_{\alpha} \alpha TT_i - \mu TT_i
\end{align}
$$

```{r pkgs,warning=FALSE,message=FALSE}
library("ggplot2"); theme_set(theme_bw())
scale_colour_discrete <- function(...,palette="Set1") scale_colour_brewer(...,palette=palette)
scale_fill_discrete <- function(...,palette="Set1") scale_fill_brewer(...,palette=palette)
library("gridExtra")
library("plyr")  ## for ldply()
library("dplyr") ## for full_join()
library("reshape2")  ## for melt()
library("GGally")
library("knitr")
## devtools::install_github("lionel-/ggstance")
library("ggstance")
```


```{r index, echo = FALSE}

N <- c(1:9)
S.HIV <- c(1,4,7)
I.HIV <- c(2,5,8)
T.HIV <- c(3,6,9)
S.syph <- c(1:3)
I.syph <- c(4:6)
T.syph <- c(7:9)

```

## All plots


```{r load,echo=FALSE,message=FALSE}

load("syphData.rda")

comp.names <- c("SS", "IS", "TS", "SI", "II", "TI", "ST", "IT", "TT")

syphList <- list()
stateNames <- c("co", "HIV", "syph")
matNames <- c("highC", "lowC")

tvec <- syph_sim.co[,1]

for(m in stateNames){
	for(i in c(1:2)){
		syphList[[m]][[matNames[i]]] <- as.data.frame(get(paste0("syph_sim.",m))[,c(1,seq(from = (i+1), by = 2, length.out = 9))])
		colnames(syphList[[m]][[matNames[i]]]) <- c("time",comp.names)
	}
}

syphFrame <- melt(syphList[["co"]], id.vars = "time")

sumList <- prev_name <- sumFrame <- list()

prev_name[["co"]] <- c("N","S.HIV","I.HIV","T.HIV","S.syph","I.syph","T.syph")
prev_name[["HIV"]] <- c("S.HIV","I.HIV","T.HIV")
prev_name[["syph"]] <- c("S.syph","I.syph","T.syph")

for(s in stateNames){
	for(m in prev_name[[s]]){
		sumList[[s]][[m]] <- ldply(syphList[[s]],
			function(x) data.frame(time = tvec, value = rowSums(x[,get(m)+1])
		))
	}
	sumFrame[[s]] <- melt(sumList[[s]], id.vars = c("time", ".id"))
	
	if(s != c("Co")){
		sumFrame[[s]]$L1 <-
			factor(sumFrame[[s]]$L1, levels = prev_name[[s]])
	}
}
```


```{r allPlot, fig.width = 10, fig.height = 10, echo = FALSE}

library("grid")

g.co <- ggplot(syphFrame, aes(time, value, col = L1)) +
	geom_line() +
	theme(legend.position="none",
		panel.margin = unit(1, "lines")) +
	labs(x = NULL, y = NULL) +
	facet_wrap(~variable, scale = "free")

g.HIV <- ggplot(subset(sumFrame[["co"]], L1 %in% c("S.HIV","I.HIV", "T.HIV")), aes(time, value, col = .id)) +
	geom_line() +
	theme(legend.position="none",
		panel.margin = unit(1, "lines")) +
	labs(x = NULL, y = NULL)+
	facet_wrap(~L1, scale = "free")

g.syph <- ggplot(subset(sumFrame[["co"]], L1 %in% c("S.syph","I.syph", "T.syph")), aes(time, value, col = .id)) +
	geom_line() +
	theme(legend.position="none",
		panel.margin = unit(1, "lines")) +
	labs(x = NULL, y = NULL)+
	facet_wrap(~L1, scale = "free", ncol = 1)

lay <- rbind(c(1,2,2,2),
	c(3,4,4,4),
	c(3,4,4,4),
	c(3,4,4,4))

library("gtable")

legend <- gtable_filter(ggplot_gtable(ggplot_build(g.co + theme(legend.position="right"))), "guide-box")

lwidth <- sum(legend$width)

grid.arrange(arrangeGrob(grid.rect(gp=gpar(col="white")), g.HIV, g.syph, g.co, ncol = 2,
	layout_matrix = lay), legend, 
	widths=unit.c(unit(1, "npc") - lwidth, lwidth), nrow=1)

```

## Total population

```{r population}

ggplot(subset(sumFrame[["co"]], L1 %in% c("N")), aes(time, value, col = .id)) +
	ylim(0, 1) +
	geom_line() +
	facet_wrap(~L1, scale = "free")

```

##Separate cases

```{r prevalence,fig.width = 10}

ggplot(sumFrame[["HIV"]], aes(time, value, col = .id)) +
	geom_line() +
	facet_wrap(~L1, scale = "free")
ggplot(sumFrame[["syph"]], aes(time, value, col = .id)) +
	geom_line() +
	facet_wrap(~L1, scale = "free")

```

